name: Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 8 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  dependency-updates:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level moderate

    - name: Check for outdated dependencies
      run: npm outdated || true

    - name: Update dependencies (patch and minor only)
      run: |
        # Update patch and minor versions only
        npm update --save
        npm update --save-dev

        # Check if package.json was modified
        if git diff --quiet package.json; then
          echo "No dependency updates needed"
        else
          echo "Dependencies updated, creating PR..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package.json package-lock.json
          git commit -m "chore: Update dependencies

- Updated patch and minor versions
- Security fixes included
- Auto-generated by GitHub Actions" || echo "No changes to commit"
        fi

    - name: Create Pull Request
      if: success()
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: dependency-updates
        delete-branch: true
        title: '🔄 Weekly Dependency Updates'
        body: |
          ## 🔄 Dependency Updates

          This PR contains automated dependency updates for:
          - Patch version updates
          - Minor version updates
          - Security fixes

          ### ✅ Testing Required
          Please run the test suite and verify functionality:
          ```bash
          npm test
          npm run lint
          npm run build
          ```

          ### 📋 Changes
          - Updated npm dependencies
          - Security vulnerability fixes (if any)
          - Maintained compatibility within semantic versioning

          ---
          *This PR was automatically created by GitHub Actions*
        labels: |
          dependencies
          automated
          maintenance
        assignees: ${{ github.actor }}

  vulnerability-scan:
    name: Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run vulnerability scan
      run: |
        echo "## 🔍 Vulnerability Scan Results" > vulnerability_report.md
        echo "" >> vulnerability_report.md
        echo "### 📊 Audit Summary" >> vulnerability_report.md
        npm audit --json > audit_results.json || true

        if [ -f audit_results.json ]; then
          # Extract vulnerability info
          vulnerabilities=$(jq '.vulnerabilities | length' audit_results.json 2>/dev/null || echo "0")
          high=$(jq '.metadata.vulnerabilities.high // 0' audit_results.json 2>/dev/null || echo "0")
          moderate=$(jq '.metadata.vulnerabilities.moderate // 0' audit_results.json 2>/dev/null || echo "0")
          low=$(jq '.metadata.vulnerabilities.low // 0' audit_results.json 2>/dev/null || echo "0")

          echo "- **Total Vulnerabilities**: $vulnerabilities" >> vulnerability_report.md
          echo "- **High Severity**: $high" >> vulnerability_report.md
          echo "- **Moderate Severity**: $moderate" >> vulnerability_report.md
          echo "- **Low Severity**: $low" >> vulnerability_report.md
        else
          echo "- **Status**: Unable to generate audit report" >> vulnerability_report.md
        fi

        echo "" >> vulnerability_report.md
        echo "### 🛡️ Recommendations" >> vulnerability_report.md
        echo "- Run \`npm audit fix\` to fix auto-fixable vulnerabilities" >> vulnerability_report.md
        echo "- Review and update dependencies manually if needed" >> vulnerability_report.md
        echo "- Consider updating to latest versions for security patches" >> vulnerability_report.md

        # Create issue if high vulnerabilities found
        if [ "$high" -gt 0 ]; then
          echo "🚨 High severity vulnerabilities found! Creating issue..."
          gh issue create \
            --title "🔴 Security Vulnerabilities Found" \
            --body "Automated security scan detected **$high high severity** vulnerabilities in dependencies. Please review and fix immediately." \
            --label security \
            --label urgent || echo "Could not create issue"
        fi
